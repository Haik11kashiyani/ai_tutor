name: Test Video Generation

on:
  workflow_dispatch:
  push:
    paths:
      - 'content.json'
      - 'youtube_automation.py'
      - 'test_single_video.py'

jobs:
  test-video:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg imagemagick fonts-dejavu-core fonts-dejavu-extra
        
    - name: Fix ImageMagick security policy
      run: |
        sudo sed -i 's/rights="none" pattern="@\*"/rights="read|write" pattern="@*"/' /etc/ImageMagick-6/policy.xml
        sudo sed -i 's/rights="none" pattern="TEXT"/rights="read|write" pattern="TEXT"/' /etc/ImageMagick-6/policy.xml
        sudo sed -i 's/rights="none" pattern="LABEL"/rights="read|write" pattern="LABEL"/' /etc/ImageMagick-6/policy.xml
        
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Verify setup
      run: |
        python -c "import PIL; print(f'Pillow version: {PIL.__version__}')"
        python -c "from PIL import Image; print(f'ANTIALIAS available: {hasattr(Image, \"ANTIALIAS\")}')"
        convert -version
        
    - name: Generate test video
      env:
        ELEVENLABS_KEY_1: ${{ secrets.ELEVENLABS_KEY_1 }}
        ELEVENLABS_KEY_2: ${{ secrets.ELEVENLABS_KEY_2 }}
        ELEVENLABS_KEY_3: ${{ secrets.ELEVENLABS_KEY_3 }}
        YOUTUBE_CLIENT_ID: ${{ secrets.YOUTUBE_CLIENT_ID }}
        YOUTUBE_CLIENT_SECRET: ${{ secrets.YOUTUBE_CLIENT_SECRET }}
        YOUTUBE_REFRESH_TOKEN: ${{ secrets.YOUTUBE_REFRESH_TOKEN }}
        GOOGLE_AI_API_KEY: ${{ secrets.GOOGLE_AI_API_KEY }}
      run: |
        python test_single_video.py
        
    - name: Upload test video as artifact
      uses: actions/upload-artifact@v4
      with:
        name: test-video-output
        path: |
          output/TEST_*.mp4
          output/TEST_*.json
          output/test_audio.mp3
        retention-days: 7
        
    - name: Video generation summary
      run: |
        echo "## ðŸ“Š Video Generation Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ -f output/TEST_day_1_python.mp4 ]; then
          echo "âœ… Test video generated successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Video Details:**" >> $GITHUB_STEP_SUMMARY
          ls -lh output/TEST_*.mp4 >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¥ **Download the video from the Artifacts section above**" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ Video generation failed!" >> $GITHUB_STEP_SUMMARY
        fi
